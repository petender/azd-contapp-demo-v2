# Azure DevOps Pipeline for Contoso Analytics
# Builds and deploys microservices to Azure Container Apps
# Uses Azure CLI and Docker directly

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - src/**
      - infra/**

pr:
  branches:
    include:
      - main
  paths:
    include:
      - src/**
      - infra/**

variables:
  # ==========================================================================
  # REQUIRED: Set these variables before running the pipeline
  # You can set them in Azure DevOps: Pipelines > Edit > Variables
  # ==========================================================================
  
  # Azure Service Connection name (created in Project Settings > Service Connections)
  - name: azureSubscription
    value: 'AzureServiceConnection'
  
  # Resource Group name from your deployment (e.g., 'rg-contoso-contapp')
  - name: resourceGroupName
    value: 'rg-yourenv'  # UPDATE THIS: Use your actual resource group name
  
  # ACR Login Server (e.g., 'acrcontosoxyz123.azurecr.io')
  - name: containerRegistryServer
    value: 'yourregistry.azurecr.io'  # UPDATE THIS: Use your ACR login server
  
  # ACR Name without domain (e.g., 'acrcontosoxyz123')
  - name: containerRegistryName
    value: 'yourregistryname'  # UPDATE THIS: Use your ACR name
  
  # Azure region
  - name: location
    value: 'eastus2'
  
  # Image Tags - uses build number for unique versioning
  - name: imageTag
    value: '$(Build.BuildId)'

stages:
  # ============================================================================
  # Stage 1: Build - Build and Test all microservices
  # ============================================================================
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      # ----------------------------------------------------------------------
      # Build Dashboard (React/Vite)
      # ----------------------------------------------------------------------
      - job: BuildDashboard
        displayName: 'Build Dashboard'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'

          - script: |
              cd src/dashboard
              npm install
              npm run build
            displayName: 'Install dependencies & build'

          - script: |
              cd src/dashboard
              docker build -t dashboard:$(imageTag)-ado -t dashboard:latest-ado .
            displayName: 'Build Docker image'

          - script: |
              docker save dashboard:$(imageTag)-ado -o $(Build.ArtifactStagingDirectory)/dashboard.tar
            displayName: 'Save Docker image'

          - publish: $(Build.ArtifactStagingDirectory)/dashboard.tar
            artifact: dashboard-image
            displayName: 'Publish Dashboard image'

      # ----------------------------------------------------------------------
      # Build Ingestion Service (.NET 8)
      # ----------------------------------------------------------------------
      - job: BuildIngestionService
        displayName: 'Build Ingestion Service'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              version: '8.x'

          - script: |
              cd src/ingestion-service
              dotnet restore
              dotnet build --configuration Release
              dotnet test --configuration Release --no-build || true
            displayName: 'Restore, build & test'

          - script: |
              cd src/ingestion-service
              docker build -t ingestion-service:$(imageTag)-ado -t ingestion-service:latest-ado .
            displayName: 'Build Docker image'

          - script: |
              docker save ingestion-service:$(imageTag)-ado -o $(Build.ArtifactStagingDirectory)/ingestion-service.tar
            displayName: 'Save Docker image'

          - publish: $(Build.ArtifactStagingDirectory)/ingestion-service.tar
            artifact: ingestion-service-image
            displayName: 'Publish Ingestion Service image'

      # ----------------------------------------------------------------------
      # Build Hello API (.NET 8)
      # ----------------------------------------------------------------------
      - job: BuildHelloApi
        displayName: 'Build Hello API'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              version: '8.x'

          - script: |
              cd src/hello-api
              dotnet restore
              dotnet build --configuration Release
              dotnet test --configuration Release --no-build || true
            displayName: 'Restore, build & test'

          - script: |
              cd src/hello-api
              docker build -t hello-api:$(imageTag)-ado -t hello-api:latest-ado .
            displayName: 'Build Docker image'

          - script: |
              docker save hello-api:$(imageTag)-ado -o $(Build.ArtifactStagingDirectory)/hello-api.tar
            displayName: 'Save Docker image'

          - publish: $(Build.ArtifactStagingDirectory)/hello-api.tar
            artifact: hello-api-image
            displayName: 'Publish Hello API image'

      # ----------------------------------------------------------------------
      # Build Demo Job (.NET 8)
      # ----------------------------------------------------------------------
      - job: BuildDemoJob
        displayName: 'Build Demo Job'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              version: '8.x'

          - script: |
              cd src/demo-job
              dotnet restore
              dotnet build --configuration Release
            displayName: 'Restore & build'

          - script: |
              cd src/demo-job
              docker build -t demo-job:$(imageTag)-ado -t demo-job:latest-ado .
            displayName: 'Build Docker image'

          - script: |
              docker save demo-job:$(imageTag)-ado -o $(Build.ArtifactStagingDirectory)/demo-job.tar
            displayName: 'Save Docker image'

          - publish: $(Build.ArtifactStagingDirectory)/demo-job.tar
            artifact: demo-job-image
            displayName: 'Publish Demo Job image'

      # ----------------------------------------------------------------------
      # Validate Infrastructure (Bicep)
      # ----------------------------------------------------------------------
      - job: ValidateInfrastructure
        displayName: 'Validate Bicep Templates'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: AzureCLI@2
            displayName: 'Validate Bicep templates'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Build Bicep to check for errors
                az bicep build --file infra/main.bicep
                echo "Bicep templates validated successfully"

          - publish: infra
            artifact: infrastructure
            displayName: 'Publish infrastructure artifacts'

  # ============================================================================
  # Stage 2: Push Images to ACR (uses existing infrastructure)
  # ============================================================================
  - stage: PushImages
    displayName: 'Push Images to ACR'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: PushToACR
        displayName: 'Push all images to ACR'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - download: current
            artifact: dashboard-image
          - download: current
            artifact: ingestion-service-image
          - download: current
            artifact: hello-api-image
          - download: current
            artifact: demo-job-image

          - task: AzureCLI@2
            displayName: 'Push images to ACR'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Use pipeline variables for ACR configuration
                CONTAINER_REGISTRY="$(containerRegistryServer)"
                CONTAINER_REGISTRY_NAME="$(containerRegistryName)"
                RESOURCE_GROUP="$(resourceGroupName)"
                
                echo "============================================"
                echo "Container Registry: $CONTAINER_REGISTRY"
                echo "Container Registry Name: $CONTAINER_REGISTRY_NAME"
                echo "Resource Group: $RESOURCE_GROUP"
                echo "============================================"
                
                # Login to ACR
                az acr login --name $CONTAINER_REGISTRY_NAME
                
                # Load and push Dashboard
                docker load -i $(Pipeline.Workspace)/dashboard-image/dashboard.tar
                docker tag dashboard:$(imageTag)-ado $CONTAINER_REGISTRY/dashboard:$(imageTag)-ado
                docker tag dashboard:$(imageTag)-ado $CONTAINER_REGISTRY/dashboard:latest-ado
                docker push $CONTAINER_REGISTRY/dashboard:$(imageTag)-ado
                docker push $CONTAINER_REGISTRY/dashboard:latest-ado
                echo "✓ Dashboard pushed"
                
                # Load and push Ingestion Service
                docker load -i $(Pipeline.Workspace)/ingestion-service-image/ingestion-service.tar
                docker tag ingestion-service:$(imageTag)-ado $CONTAINER_REGISTRY/ingestion-service:$(imageTag)-ado
                docker tag ingestion-service:$(imageTag)-ado $CONTAINER_REGISTRY/ingestion-service:latest-ado
                docker push $CONTAINER_REGISTRY/ingestion-service:$(imageTag)-ado
                docker push $CONTAINER_REGISTRY/ingestion-service:latest-ado
                echo "✓ Ingestion Service pushed"
                
                # Load and push Hello API
                docker load -i $(Pipeline.Workspace)/hello-api-image/hello-api.tar
                docker tag hello-api:$(imageTag)-ado $CONTAINER_REGISTRY/hello-api:$(imageTag)-ado
                docker tag hello-api:$(imageTag)-ado $CONTAINER_REGISTRY/hello-api:latest-ado
                docker push $CONTAINER_REGISTRY/hello-api:$(imageTag)-ado
                docker push $CONTAINER_REGISTRY/hello-api:latest-ado
                echo "✓ Hello API pushed"
                
                # Load and push Demo Job
                docker load -i $(Pipeline.Workspace)/demo-job-image/demo-job.tar
                docker tag demo-job:$(imageTag)-ado $CONTAINER_REGISTRY/demo-job:$(imageTag)-ado
                docker tag demo-job:$(imageTag)-ado $CONTAINER_REGISTRY/demo-job:latest-ado
                docker push $CONTAINER_REGISTRY/demo-job:$(imageTag)-ado
                docker push $CONTAINER_REGISTRY/demo-job:latest-ado
                echo "✓ Demo Job pushed"
                
                echo "============================================"
                echo "All images pushed successfully!"
                echo "============================================"

  # ============================================================================
  # Stage 3: Deploy to Container Apps
  # ============================================================================
  - stage: DeployApps
    displayName: 'Deploy to Container Apps'
    dependsOn: PushImages
    jobs:
      - deployment: DeployContainerApps
        displayName: 'Deploy Container Apps'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Update Ingestion Service'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az containerapp update \
                        --name ingestion-service \
                        --resource-group $(resourceGroupName) \
                        --image $(containerRegistryServer)/ingestion-service:$(imageTag)-ado
                      echo "✓ Ingestion Service updated"

                - task: AzureCLI@2
                  displayName: 'Update Dashboard'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az containerapp update \
                        --name dashboard \
                        --resource-group $(resourceGroupName) \
                        --image $(containerRegistryServer)/dashboard:$(imageTag)-ado
                      echo "✓ Dashboard updated"

                - task: AzureCLI@2
                  displayName: 'Update Hello API'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az containerapp update \
                        --name hello-api \
                        --resource-group $(resourceGroupName) \
                        --image $(containerRegistryServer)/hello-api:$(imageTag)-ado
                      echo "✓ Hello API updated"

                - task: AzureCLI@2
                  displayName: 'Update Container Jobs'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az containerapp job update \
                        --name data-processor-scheduled \
                        --resource-group $(resourceGroupName) \
                        --image $(containerRegistryServer)/demo-job:$(imageTag)-ado
                      
                      az containerapp job update \
                        --name data-processor-manual \
                        --resource-group $(resourceGroupName) \
                        --image $(containerRegistryServer)/demo-job:$(imageTag)-ado
                      
                      az containerapp job update \
                        --name data-processor-parallel \
                        --resource-group $(resourceGroupName) \
                        --image $(containerRegistryServer)/demo-job:$(imageTag)-ado
                      echo "✓ All Container Jobs updated"

                - task: AzureCLI@2
                  displayName: 'Display deployment URLs'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "============================================"
                      echo "       Deployment Complete!"
                      echo "============================================"
                      echo ""
                      echo "Dashboard URL:"
                      az containerapp show --name dashboard --resource-group $(resourceGroupName) --query properties.configuration.ingress.fqdn -o tsv | xargs -I {} echo "  https://{}"
                      echo ""
                      echo "Ingestion Service URL:"
                      az containerapp show --name ingestion-service --resource-group $(resourceGroupName) --query properties.configuration.ingress.fqdn -o tsv | xargs -I {} echo "  https://{}"
                      echo ""
                      echo "Hello API URL:"
                      az containerapp show --name hello-api --resource-group $(resourceGroupName) --query properties.configuration.ingress.fqdn -o tsv | xargs -I {} echo "  https://{}"
                      echo ""
                      echo "Build ID: $(imageTag)"
                      echo "============================================"
